# /config/roles/argocd_install/tasks/main.yml
---
- name: Set target ArgoCD version
  ansible.builtin.set_fact:
    argocd_target_version: >-
      {{ requested_version | default(argocd_version) }}

- name: Create or Remove ArgoCD namespace
  kubernetes.core.k8s:
    name: "{{ argocd_namespace }}"
    api_version: v1
    kind: Namespace
    state: "{{ addon_state }}" # <-- USING VARIABLE

- name: Apply or Remove ArgoCD manifest
  kubernetes.core.k8s:
    state: "{{ addon_state }}" # <-- USING VARIABLE
    src: "{{ argocd_install_url }}"
    namespace: "{{ argocd_namespace }}"
  register: argocd_apply_result

# (Other tasks like 'wait' and 'get password'
# should only run during installation)

- name: Wait for ArgoCD Server readiness
  ansible.builtin.shell: >
    kubectl wait --for=condition=ready pod
    -l app.kubernetes.io/name=argocd-server -n {{ argocd_namespace }} --timeout=600s
  changed_when: false
  when: addon_state == "present" # <-- RUN ONLY DURING INSTALLATION

- name: Get ArgoCD admin initial password
  ansible.builtin.shell:
    cmd: "kubectl -n {{ argocd_namespace }} get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d"
  register: argocd_admin_password
  changed_when: false
  ignore_errors: true
  when: addon_state == "present" # <-- RUN ONLY DURING INSTALLATION

- name: Check running pods in {{ argocd_namespace }}
  ansible.builtin.shell: "kubectl get pods -n {{ argocd_namespace }} --no-headers | grep -c 'Running'"
  register: argocd_final_check
  changed_when: false
  when: addon_state == "present" # <-- RUN ONLY DURING INSTALLATION

- name: Display result
  ansible.builtin.debug:
    msg:
      - "ArgoCD GitOps {{ addon_state }} completed"
      - "Version: {{ argocd_target_version }}"
      - "Running pods: {{ argocd_final_check.stdout | default('N/A (removed)') }}"
      - "Username: admin"
      - "Password: {{ argocd_admin_password.stdout | default('N/A (removed)') }}"
  when: addon_state == "present"
