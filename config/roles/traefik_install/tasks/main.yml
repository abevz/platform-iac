# /config/roles/traefik_install/tasks/main.yml
---
# ... (Helm installation tasks remain unchanged) ...

- name: Add Traefik Helm repository
  kubernetes.core.helm_repository:
    name: traefik
    repo_url: https://helm.traefik.io/traefik
    state: present # Repository must always be present

- name: Install/Remove Gateway API CRDs
  kubernetes.core.k8s:
    state: "{{ addon_state }}" # <-- USING VARIABLE
    src: "{{ item }}"
  loop: "{{ gateway_api_crd_urls }}"
  register: gateway_api_result

- name: Copy values file (install only)
  ansible.builtin.copy:
    src: traefik-values.yaml
    dest: /tmp/traefik-values.yaml
    mode: '0644'
  when: addon_state == "present"

- name: Install/Remove Traefik (Helm)
  kubernetes.core.helm:
    name: traefik
    chart_ref: traefik/traefik
    release_namespace: traefik
    create_namespace: "{{ addon_state == 'present' }}" # Create only when installing
    state: "{{ addon_state }}" # <-- USING VARIABLE
    version: "{{ traefik_gateway_target_version }}"
    values_files:
      - /tmp/traefik-values.yaml
    wait: yes
    timeout: 5m
  register: helm_install_result

- name: Display result
  ansible.builtin.debug:
    msg: "Traefik Gateway ({{ addon_state }}) complete."
