# /config/roles/harbor_setup/templates/docker-compose.yml.j2
# –§–∞–π–ª —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Ansible.
# –í –≠–¢–û–ô –í–ï–†–°–ò–ò –î–û–ë–ê–í–õ–ï–ù–´ 'healthcheck' –ò 'depends_on' –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø 'connection refused'

services:
  # Nginx (–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ–∫—Å–∏ Harbor, –Ω–µ –í–∞—à –≤–Ω–µ—à–Ω–∏–π nginx-proxy)
  nginx:
    image: goharbor/nginx-photon:{{ harbor_version }}
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:8080" # –ú—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º 8080 –∫–∞–∫ –ø–æ—Ä—Ç 80, –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ harbor.yml
    volumes:
      - ./common/config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      harbor-core:
        condition: service_healthy # üëà –ñ–¥–∞—Ç—å, –ø–æ–∫–∞ 'core' –±—É–¥–µ—Ç –∑–¥–æ—Ä–æ–≤
      harbor-portal:
        condition: service_started
    networks:
      - harbor

  # Harbor Core (–ì–ª–∞–≤–Ω—ã–π API)
  harbor-core:
    image: goharbor/harbor-core:{{ harbor_version }}
    container_name: harbor-core
    restart: unless-stopped
    volumes:
      - ./common/config/core/app.conf:/etc/core/app.conf:ro
      - ./common/config/core/private_key.pem:/etc/core/private_key.pem:ro
      - /data/ca_download/:/data/ca_download/:ro
      - /data/psc/:/data/psc/:ro
      - /data/secret:/etc/core/secret
    networks:
      - harbor
    depends_on:
      harbor-db:
        condition: service_healthy
      redis:
        condition: service_healthy
    # üëà *** –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ***
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/v2.0/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s # –î–∞—Ç—å 30—Å –Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—é –ë–î –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π

  # Harbor Jobservice (–ö–æ—Ç–æ—Ä—ã–π –ø–∞–¥–∞–ª)
  harbor-jobservice:
    image: goharbor/harbor-jobservice:{{ harbor_version }}
    container_name: harbor-jobservice
    restart: unless-stopped
    volumes:
      - ./common/config/jobservice/app.conf:/etc/jobservice/app.conf:ro
      - /data/job_logs:/var/log/jobs:rw
      - /data/secret:/etc/jobservice/secret
    networks:
      - harbor
    # üëà *** –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ***
    depends_on:
      harbor-core:
        condition: service_healthy # üëà –ó–∞–ø—É—Å–∫–∞—Ç—å—Å—è –¢–û–õ–¨–ö–û –ü–û–°–õ–ï 'core'
      harbor-db:
        condition: service_healthy
      redis:
        condition: service_healthy

  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  harbor-db:
    image: goharbor/harbor-db:{{ harbor_version }}
    container_name: harbor-db
    restart: unless-stopped
    volumes:
      - /data/database:/var/lib/postgresql/data
    networks:
      - harbor
    environment:
      #POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_PASSWORD: "{{ harbor.db_password | default('ChangeThisDBPassword') }}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: goharbor/redis-photon:{{ harbor_version }}
    container_name: redis
    restart: unless-stopped
    volumes:
      - /data/redis:/data
    networks:
      - harbor
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5

  # –û—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã...
  harbor-portal:
    image: goharbor/harbor-portal:{{ harbor_version }}
    container_name: harbor-portal
    restart: unless-stopped
    networks:
      - harbor
    depends_on:
      harbor-core:
        condition: service_healthy

  registry:
    image: goharbor/registry-photon:{{ harbor_version }}
    container_name: registry
    restart: unless-stopped
    volumes:
      - /data/registry:/storage
      - ./common/config/registry/config.yml:/etc/registry/config.yml:ro
    networks:
      - harbor
    depends_on:
      harbor-db:
        condition: service_healthy
      redis:
        condition: service_healthy

  registryctl:
    image: goharbor/registryctl-photon:{{ harbor_version }}
    container_name: registryctl
    restart: unless-stopped
    volumes:
      - ./common/config/registryctl/config.yml:/etc/registryctl/config.yml:ro
    networks:
      - harbor
    depends_on:
      registry:
        condition: service_started

  trivy:
    image: goharbor/trivy-adapter-photon:{{ harbor_version }}
    container_name: trivy
    restart: unless-stopped
    volumes:
      - /data/trivy-adapter:/home/scanner
    networks:
      - harbor
    depends_on:
      harbor-core:
        condition: service_healthy
      redis:
        condition: service_healthy

  harbor-log:
    image: goharbor/harbor-log:{{ harbor_version }}
    container_name: harbor-log
    restart: unless-stopped
    volumes:
      - /var/log/harbor:/var/log/docker:rw
    networks:
      - harbor

networks:
  harbor:
    external: false
