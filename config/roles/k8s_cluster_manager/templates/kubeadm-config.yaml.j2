---
apiVersion: kubeadm.k8s.io/v1beta3 # Reverting to working API compatible with your kubeletExtraArgs format
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: {{ ansible_default_ipv4.address }}
  bindPort: 6443
nodeRegistration:
  kubeletExtraArgs:
    node-ip: {{ ansible_default_ipv4.address }}
---
apiVersion: kubeadm.k8s.io/v1beta3 # Reverting to working API
kind: ClusterConfiguration
# FIX: Forced version formatting.
# "1.33" -> "v1.33.0". "1.29.0" -> "v1.29.0".
kubernetesVersion: "v{{ kubernetes_version | replace('v', '') }}{{ '.0' if kubernetes_version | split('.') | length < 3 else '' }}"
controlPlaneEndpoint: "{{ ansible_fqdn }}:6443"
apiServer:
  certSANs:
  - {{ ansible_default_ipv4.address }}
  - {{ ansible_hostname }}
  - {{ ansible_fqdn }}
  - localhost
  - 127.0.0.1
  - kubernetes
  - kubernetes.default
  - kubernetes.default.svc
  - kubernetes.default.svc.cluster.local
networking:
  dnsDomain: cluster.local
  podSubnet: {{ pod_cidr }}
  serviceSubnet: 10.96.0.0/12
---
# This block enables ServerTLSBootstrap for ALL kubelets (including workers)
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
serverTLSBootstrap: true
