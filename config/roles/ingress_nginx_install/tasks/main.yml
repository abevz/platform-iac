# /config/roles/ingress_nginx_install/tasks/main.yml
---
# ... (tasks 'set_fact' and 'check current version' remain only for 'present') ...
- name: Set target ingress-nginx version
  ansible.builtin.set_fact:
    ingress_nginx_target_version: >-
      {{ requested_version | default(ingress_nginx_version) }}
  when: addon_state == "present"

- name: Check current ingress-nginx version (if installed)
  ansible.builtin.shell:
    cmd: "kubectl get pods -n ingress-nginx -o jsonpath='{.items[0].spec.containers[0].image}' | cut -d':' -f2"
  register: current_ingress_nginx_version
  ignore_errors: true
  changed_when: false
  when: addon_state == "present"

- name: Apply/Remove ingress-nginx manifest (baremetal)
  kubernetes.core.k8s:
    state: "{{ addon_state }}" # <-- USING VARIABLE
    src: "{{ ingress_nginx_deploy_url }}"
  register: ingress_nginx_apply_result

- name: Wait for ingress-nginx pods readiness
  ansible.builtin.shell: >
    kubectl wait --for=condition=ready pod
    -l app.kubernetes.io/name=ingress-nginx -n ingress-nginx --timeout=300s
  changed_when: false
  when: ingress_nginx_apply_result.changed and addon_state == "present"

- name: Display result
  ansible.builtin.debug:
    msg: "ingress-nginx ({{ addon_state }}) complete."
