---
# --- SECTION 0: PATH VARIABLES ---
- name: "Vars: Define Dotfiles paths"
  ansible.builtin.set_fact:
    # Sources (Source of Truth)
    dotfiles_niri_src: "/home/{{ ansible_user_id }}/github/dotfiles/files/niri"
    dotfiles_scripts_src: "/home/{{ ansible_user_id }}/github/dotfiles/personal-scripts/.local/bin"
    dotfiles_systemd_src: "/home/{{ ansible_user_id }}/github/dotfiles/files/systemd"

    # Target paths
    niri_config_dir: "/home/{{ ansible_user_id }}/.config/niri"
    local_bin: "/home/{{ ansible_user_id }}/.local/bin"
  tags: always

# --- SECTION 1: CLEANUP AND DRIVERS ---
- name: "NVIDIA: Force removal of conflicting packages (KMS Cleanup)"
  ansible.builtin.command: "pacman -Rdd --noconfirm nvidia-dkms nvidia-open-dkms nvidia-utils lib32-nvidia-utils egl-x11"
  failed_when: false
  become: yes

- name: "System: Remove standard Waybar version (for waybar-git)"
  ansible.builtin.command: "pacman -Rns waybar --noconfirm"
  failed_when: false
  become: yes

- name: "System: Install Niri dependencies and tools"
  ansible.builtin.package:
    name:
      - base-devel
      - git
      - patchelf
      - niri
      - fuzzel
      - mako
      - kanshi
      - xorg-xwayland
      - egl-x11
      - jq # For layout script
      - libnotify # For notifications
    state: present
  become: yes

- name: "AUR: Install 580xx drivers and Waybar-git"
  ansible.builtin.shell: |
    yay -S --noconfirm --needed \
    nvidia-580xx-dkms \
    nvidia-580xx-utils \
    lib32-nvidia-580xx-utils \
    waybar-git
  become: no
  register: aur_install
  changed_when: "'Installing' in aur_install.stdout"

# --- SECTION 2: KERNEL CONFIGURATION ---
- name: "NVIDIA: Configure kernel modules for Wayland"
  ansible.builtin.copy:
    dest: "/etc/modprobe.d/nvidia.conf"
    content: |
      options nvidia_drm modeset=1
      options nvidia_drm fbdev=1
    owner: root
    group: root
    mode: "0644"
  become: yes

- name: "NVIDIA: Rebuild initramfs (mkinitcpio)"
  ansible.builtin.command: "mkinitcpio -P"
  when: aur_install.changed
  become: yes

# --- SECTION 3: SCRIPTS (Layouts) ---
- name: "Layout: Place niri-layout script in personal-scripts"
  ansible.builtin.copy:
    src: "niri-layout"
    dest: "{{ dotfiles_scripts_src }}/niri-layout"
    mode: "0755"

- name: "System: Symlink script to ~/.local/bin"
  ansible.builtin.file:
    src: "{{ dotfiles_scripts_src }}/niri-layout"
    dest: "{{ local_bin }}/niri-layout"
    state: link
    force: yes

# --- SECTION 4: CONFIGURATION AND SYMLINKS ---
- name: "Config: Create directory structure"
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - niri
    - waybar
    - mako
    - kanshi
    - systemd/user

- name: "Config: Create symlinks (Niri)"
  ansible.builtin.file:
    src: "{{ dotfiles_niri_src }}/{{ item }}"
    dest: "{{ niri_config_dir }}/{{ item }}"
    state: link
    force: yes
  loop:
    - config.kdl
    - keybindings.kdl
    # help.txt REMOVED
  notify: Reload Niri

- name: "Config: Create remaining symlinks (Waybar, Kanshi, Mako)"
  ansible.builtin.file:
    src: "{{ ansible_user_dir }}/github/dotfiles/files/{{ item.src }}"
    dest: "{{ ansible_user_dir }}/.config/{{ item.dest }}"
    state: link
    force: yes
  loop:
    - { src: "waybar/config.jsonc", dest: "waybar/config.jsonc" }
    - { src: "waybar/style.css", dest: "waybar/style.css" }
    - { src: "kanshi/config", dest: "kanshi/config" }
    - { src: "mako/config", dest: "mako/config" }

# --- SECTION 5: SYSTEMD SERVICES ---
- name: "Systemd: Deploy user units"
  ansible.builtin.copy:
    src: "{{ dotfiles_systemd_src }}/{{ item }}"
    dest: "{{ ansible_user_dir }}/.config/systemd/user/{{ item }}"
    mode: "0644"
  loop:
    - waybar.service
    - mako.service

- name: "Systemd: Activate and restart services"
  ansible.builtin.systemd:
    daemon_reload: yes
    scope: user
    name: "{{ item }}"
    enabled: yes
    state: restarted
  loop:
    - waybar.service
    - mako.service
