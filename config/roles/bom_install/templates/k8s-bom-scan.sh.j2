#!/bin/bash
# k8s-bom-scan.sh.j2
# Файл управляется Ansible. НЕ РЕДАКТИРОВАТЬ ВРУЧНУЮ.

# Kubernetes Cluster Bill of Materials Generator
NAMESPACE="${1:-default}"
OUTPUT_DIR="${2:-/tmp/bom-reports}"

mkdir -p "$OUTPUT_DIR"

echo "Generating BOM for namespace: $NAMESPACE"

# 1. Получаем список образов и фильтруем пустые строки
kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].spec.containers[*].image}' | \
  tr ' ' '\n' | sort -u | grep -v "^$" > "$OUTPUT_DIR/images-$NAMESPACE.txt"

IMAGE_COUNT=$(wc -l < "$OUTPUT_DIR/images-$NAMESPACE.txt")
echo "Found $IMAGE_COUNT unique images"

if [ "$IMAGE_COUNT" -eq 0 ]; then
    echo "No images found in namespace $NAMESPACE. Exiting."
    exit 0
fi

# 2. Генерируем SBOM, если утилита установлена
if command -v bom >/dev/null 2>&1; then
  echo "Generating SPDX document..."

  # Формируем массив аргументов для bom (-i image1 -i image2 ...)
  # Это самый безопасный способ передать список аргументов в bash
  BOM_ARGS=()
  while read -r img; do
      if [ -n "$img" ]; then
          BOM_ARGS+=("-i" "$img")
      fi
  done < "$OUTPUT_DIR/images-$NAMESPACE.txt"

  # Запускаем bom
  bom generate -o "$OUTPUT_DIR/bom-$NAMESPACE.spdx.json" \
    --format json "${BOM_ARGS[@]}" || echo "BOM generation failed"
else
  echo "WARNING: 'bom' utility not found. Skipping SPDX generation."
fi

# 3. Генерируем простой Markdown отчет
REPORT_FILE="$OUTPUT_DIR/report-$NAMESPACE.md"
echo "# Bill of Materials Report for namespace: $NAMESPACE" > "$REPORT_FILE"
echo "Generated: $(date)" >> "$REPORT_FILE"
echo "" >> "$REPORT_FILE"
echo "## Container Images" >> "$REPORT_FILE"
while read -r image; do
  echo "- $image" >> "$REPORT_FILE"
done < "$OUTPUT_DIR/images-$NAMESPACE.txt"

echo "Reports generated in: $OUTPUT_DIR"
ls -la "$OUTPUT_DIR"
