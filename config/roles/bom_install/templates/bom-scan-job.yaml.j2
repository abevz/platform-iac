apiVersion: batch/v1
kind: Job
metadata:
  name: cluster-bom-scan
  namespace: {{ bom_namespace }}
spec:
  template:
    spec:
      serviceAccountName: bom-scanner
      containers:
      - name: bom-scanner
        image: alpine:latest
        command:
        - /bin/sh
        - -c
        - |
          # 1. Install dependencies
          apk add --no-cache curl bash

          # 2. Install kubectl (needed to get pod list)
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /usr/local/bin/

          # 3. Install bom
          curl -L "https://github.com/kubernetes-sigs/bom/releases/download/v{{ bom_target_version }}/bom-amd64-linux" -o /usr/local/bin/bom
          chmod +x /usr/local/bin/bom

          echo "Scanning cluster for software components..."

          # 4. Get list of images
          kubectl get pods --all-namespaces -o jsonpath='{.items[*].spec.containers[*].image}' | tr ' ' '\n' | sort -u | grep -v "^$" > /tmp/cluster-images.txt

          IMAGE_COUNT=$(wc -l < /tmp/cluster-images.txt)
          echo "Found $IMAGE_COUNT unique images"

          if [ "$IMAGE_COUNT" -eq 0 ]; then
              echo "No images found."
              exit 0
          fi

          # 5. Generate SBOM (using bash for arrays)
          /bin/bash -c '
            BOM_ARGS=()
            while read -r img; do
                if [ -n "$img" ]; then
                    BOM_ARGS+=("-i" "$img")
                fi
            done < /tmp/cluster-images.txt

            echo "Generating SPDX document..."
            /usr/local/bin/bom generate -o /tmp/cluster-bom.spdx.json --format json "${BOM_ARGS[@]}" || echo "BOM generation failed"
          '

          echo "BOM scan completed."
          if [ -f /tmp/cluster-bom.spdx.json ]; then
            echo "Report generated: /tmp/cluster-bom.spdx.json"
            ls -lh /tmp/cluster-bom.spdx.json
          fi

          # Wait to view logs or copy file
          sleep 60
      restartPolicy: Never
  backoffLimit: 3
