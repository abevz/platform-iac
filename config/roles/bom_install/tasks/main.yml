# config/roles/bom_install/tasks/main.yml
# /config/roles/bom_install/tasks/main.yml
---
- name: Set target BOM version
  ansible.builtin.set_fact:
    bom_target_version: >-
      {{ requested_version | default(bom_version, true) }}

- name: Download and install BOM CLI (if needed)
  ansible.builtin.shell: |
    ARCH=$(uname -m)
    case $ARCH in
      x86_64) ARCH="amd64" ;;
      aarch64) ARCH="arm64" ;;
      armv7l) ARCH="arm" ;;
    esac

    BINARY_NAME="bom-${ARCH}-linux"

    # 1. Download binary
    curl -L "https://github.com/kubernetes-sigs/bom/releases/download/v{{ bom_target_version }}/${BINARY_NAME}" -o "/tmp/${BINARY_NAME}"

    # 2. Download common checksums.txt file
    curl -L "https://github.com/kubernetes-sigs/bom/releases/download/v{{ bom_target_version }}/checksums.txt" -o /tmp/bom_checksums.txt

    # 3. Extract expected hash for our file from checksums.txt
    # Find line containing our filename
    EXPECTED_HASH=$(grep "${BINARY_NAME}$" /tmp/bom_checksums.txt | awk '{print $1}')

    # 4. Calculate actual hash of downloaded file
    ACTUAL_HASH=$(sha256sum "/tmp/${BINARY_NAME}" | awk '{print $1}')

    # 5. Compare
    if [ -z "$EXPECTED_HASH" ]; then
        echo "ERROR: Could not find hash for ${BINARY_NAME} in checksums.txt"
        exit 1
    fi

    if [ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]; then
      echo "ERROR: Checksum mismatch!"
      echo "Expected: $EXPECTED_HASH"
      echo "Actual:   $ACTUAL_HASH"
      rm -f "/tmp/${BINARY_NAME}" /tmp/bom_checksums.txt
      exit 1
    fi
    echo "Checksum OK: $ACTUAL_HASH"

    # 6. Install
    mv "/tmp/${BINARY_NAME}" /usr/local/bin/bom
    chmod +x /usr/local/bin/bom
    rm -f /tmp/bom_checksums.txt
  args:
    creates: /usr/local/bin/bom
  when: addon_state == "present"
  changed_when: true

- name: Remove BOM CLI
  ansible.builtin.file:
    path: /usr/local/bin/bom
    state: absent
  when: addon_state == "absent"

- name: Create/Remove bom-system namespace
  kubernetes.core.k8s:
    name: "{{ bom_namespace }}"
    api_version: v1
    kind: Namespace
    state: "{{ addon_state }}"

- name: Install/Remove RBAC for bom-scanner
  kubernetes.core.k8s:
    state: "{{ addon_state }}"
    definition: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: bom-scanner
        namespace: "{{ bom_namespace }}"
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: bom-scanner
      rules:
      - apiGroups: [""]
        resources: ["pods", "nodes", "namespaces"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["apps"]
        resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["batch"]
        resources: ["jobs", "cronjobs"]
        verbs: ["get", "list", "watch"]
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: bom-scanner
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: bom-scanner
      subjects:
      - kind: ServiceAccount
        name: bom-scanner
        namespace: "{{ bom_namespace }}"

- name: Create Job template from file
  ansible.builtin.template:
    src: bom-scan-job.yaml.j2
    dest: /tmp/bom-scan-job.yaml
    mode: "0644"
  when: addon_state == "present"

- name: Remove Job template
  ansible.builtin.file:
    path: /tmp/bom-scan-job.yaml
    state: absent
  when: addon_state == "absent"

- name: Create k8s-bom-scan script from template
  ansible.builtin.template:
    src: k8s-bom-scan.sh.j2
    dest: /usr/local/bin/k8s-bom-scan
    mode: "0755"
  when: addon_state == "present"

- name: Remove k8s-bom-scan script
  ansible.builtin.file:
    path: /usr/local/bin/k8s-bom-scan
    state: absent
  when: addon_state == "absent"

- name: Display result (install only)
  ansible.builtin.debug:
    msg:
      - "BOM (Bill of Materials) scanner ({{ addon_state }}) completed"
      - "Target version: {{ bom_target_version }}"
      - "BOM CLI: /usr/local/bin/bom"
      - "Scan script: /usr/local/bin/k8s-bom-scan"
      - "Job template: /tmp/bom-scan-job.yaml"
      - "Usage: k8s-bom-scan <namespace> [output-dir]"
  when: addon_state == "present"
