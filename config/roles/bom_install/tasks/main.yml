# config/roles/bom_install/tasks/main.yml
# /config/roles/bom_install/tasks/main.yml
---
- name: Установить целевую версию BOM
  ansible.builtin.set_fact:
    bom_target_version: >-
      {{ requested_version | default(bom_version) }}

- name: Скачать и установить BOM CLI (если нужен)
  ansible.builtin.shell: |
    ARCH=$(uname -m)
    case $ARCH in
      x86_64) ARCH="amd64" ;;
      aarch64) ARCH="arm64" ;;
      armv7l) ARCH="arm" ;;
    esac
    
    # Download binary and checksum
    curl -L "https://github.com/kubernetes-sigs/bom/releases/download/v{{ bom_target_version }}/bom-${ARCH}-linux" -o /tmp/bom-${ARCH}-linux
    curl -L "https://github.com/kubernetes-sigs/bom/releases/download/v{{ bom_target_version }}/bom-${ARCH}-linux.sha256" -o /tmp/bom-${ARCH}-linux.sha256
    
    # Verify checksum
    if ! sha256sum --check /tmp/bom-${ARCH}-linux.sha256; then
      echo "ERROR: BOM binary checksum verification failed!"
      rm -f /tmp/bom-${ARCH}-linux /tmp/bom-${ARCH}-linux.sha256
      exit 1
    fi
    
    # Move to final location and set permissions
    mv /tmp/bom-${ARCH}-linux /usr/local/bin/bom
    chmod +x /usr/local/bin/bom
    rm -f /tmp/bom-${ARCH}-linux.sha256
  args:
    creates: /usr/local/bin/bom # Идемпотентность
  when: addon_state == "present"
  changed_when: true # (Сложно отследить, считаем что всегда меняет, если 'creates' не прошел)

- name: Удалить BOM CLI
  ansible.builtin.file:
    path: /usr/local/bin/bom
    state: absent
  when: addon_state == "absent"

- name: Установить/Удалить зависимости (pip)
  ansible.builtin.package:
    name: python3-pip
    state: "{{ addon_state }}" # 'present' или 'absent'

- name: Установить/Удалить Python SPDX tools
  ansible.builtin.pip:
    name:
      - spdx-tools
      - cyclonedx-bom
    state: "{{ addon_state }}"

- name: Создать/Удалить неймспейс bom-system
  kubernetes.core.k8s:
    name: "{{ bom_namespace }}"
    api_version: v1
    kind: Namespace
    state: "{{ addon_state }}"

- name: Установить/Удалить RBAC для bom-scanner
  kubernetes.core.k8s:
    state: "{{ addon_state }}"
    definition: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: bom-scanner
        namespace: "{{ bom_namespace }}"
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: bom-scanner
      rules:
      - apiGroups: [""]
        resources: ["pods", "nodes", "namespaces"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["apps"]
        resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
        verbs: ["get", "list", "watch"]
      - apiGroups: ["batch"]
        resources: ["jobs", "cronjobs"]
        verbs: ["get", "list", "watch"]
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: bom-scanner
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: bom-scanner
      subjects:
      - kind: ServiceAccount
        name: bom-scanner
        namespace: "{{ bom_namespace }}"

- name: Создать/Удалить шаблон Job'а
  ansible.builtin.copy:
    content: |
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: cluster-bom-scan
        namespace: bom-system
      spec:
        template:
          spec:
            serviceAccountName: bom-scanner
            containers:
            - name: bom-scanner
              image: alpine:latest
              command:
              - /bin/sh
              - -c
              - |
                apk add --no-cache curl
                curl -L "https://github.com/kubernetes-sigs/bom/releases/download/v{{ bom_target_version }}/bom-amd64-linux" -o /usr/local/bin/bom
                chmod +x /usr/local/bin/bom
                
                echo "Scanning cluster for software components..."
                kubectl get pods --all-namespaces -o jsonpath='{.items[*].spec.containers[*].image}' | tr ' ' '\n' | sort -u > /tmp/cluster-images.txt
                
                echo "Found images:"
                cat /tmp/cluster-images.txt
                
                /usr/local/bin/bom generate -o /tmp/cluster-bom.spdx.json --format json /tmp/cluster-images.txt || true
                
                echo "BOM scan completed. Results:"
                if [ -f /tmp/cluster-bom.spdx.json ]; then
                  cat /tmp/cluster-bom.spdx.json
                fi
                sleep 30
            restartPolicy: Never
        backoffLimit: 3
    dest: /tmp/bom-scan-job.yaml
    mode: '0644'
    state: "{{ addon_state }}" # (управляем файлом)

- name: Создать/Удалить скрипт k8s-bom-scan
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Kubernetes Cluster Bill of Materials Generator
      NAMESPACE="${1:-default}"
      OUTPUT_DIR="${2:-/tmp/bom-reports}"
      mkdir -p "$OUTPUT_DIR"
      echo "Generating BOM for namespace: $NAMESPACE"
      kubectl get pods -n "$NAMESPACE" -o jsonpath='{.items[*].spec.containers[*].image}' | \
        tr ' ' '\n' | sort -u > "$OUTPUT_DIR/images-$NAMESPACE.txt"
      echo "Found $(wc -l < "$OUTPUT_DIR/images-$NAMESPACE.txt") unique images"
      if command -v bom >/dev/null 2>&1; then
        echo "Generating SPDX document..."
        bom generate -o "$OUTPUT_DIR/bom-$NAMESPACE.spdx.json" \
          --format json "$OUTPUT_DIR/images-$NAMESPACE.txt" || true
      fi
      echo "# Bill of Materials Report for namespace: $NAMESPACE" > "$OUTPUT_DIR/report-$NAMESPACE.md"
      echo "Generated: $(date)" >> "$OUTPUT_DIR/report-$NAMESPACE.md"
      echo "" >> "$OUTPUT_DIR/report-$NAMESPACE.md"
      echo "## Container Images" >> "$OUTPUT_DIR/report-$NAMESPACE.md"
      while read -r image; do
        echo "- $image" >> "$OUTPUT_DIR/report-$NAMESPACE.md"
      done < "$OUTPUT_DIR/images-$NAMESPACE.txt"
      echo "Reports generated in: $OUTPUT_DIR"
      ls -la "$OUTPUT_DIR"
    dest: /usr/local/bin/k8s-bom-scan
    mode: '0755'
    state: "{{ addon_state }}" # (управляем файлом)

- name: Показать результат (только при установке)
  ansible.builtin.debug:
    msg:
      - "BOM (Bill of Materials) scanner ({{ addon_state }}) completed"
      - "Target version: {{ bom_target_version }}"
      - "BOM CLI: /usr/local/bin/bom"
      - "Scan script: /usr/local/bin/k8s-bom-scan"
      - "Job template: /tmp/bom-scan-job.yaml"
      - "Usage: k8s-bom-scan <namespace> [output-dir]"
  when: addon_state == "present"
