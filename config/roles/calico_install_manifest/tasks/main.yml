# /config/roles/calico_install_manifest/tasks/main.yml
---
- name: Install/Remove Calico Operator (via Manifest)
  kubernetes.core.k8s:
    state: "{{ addon_state | default('present') }}" # <-- USING VARIABLE
    src: "{{ calico_operator_manifest_url }}"
    wait: yes
    timeout: 5m
  register: calico_operator_install

- name: Install/Remove Calico Custom Resources (via Manifest)
  kubernetes.core.k8s:
    state: "{{ addon_state | default('present') }}" # <-- USING VARIABLE
    src: "{{ calico_cr_manifest_url }}"
    wait: yes
    timeout: 5m
  register: calico_cr_install

- name: Wait for Calico readiness (install only)
  when: addon_state == "present"
  block:
    - name: Wait for Calico Deployments to be available
      ansible.builtin.command: "kubectl wait --for=condition=Available deployment --all -n calico-system --timeout=300s"
      changed_when: true
      when: calico_operator_install.changed or calico_cr_install.changed

    - name: Wait for Calico DaemonSet to be ready
      ansible.builtin.command: "kubectl rollout status daemonset/calico-node -n calico-system --timeout=300s"
      changed_when: true
      when: calico_operator_install.changed or calico_cr_install.changed

- name: Display result
  ansible.builtin.debug:
    msg: "Calico Manifests ({{ addon_state | default('present') }}) complete."
