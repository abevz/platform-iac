# config/roles/certbot_setup/tasks/main.yml
# /config/roles/certbot_setup/tasks/main.yml
---
- name: Install/Remove dependencies (python venv)
  ansible.builtin.apt:
    name: python3-venv
    state: "{{ addon_state }}"
  become: yes

- name: Create/Remove Python venv for Certbot
  ansible.builtin.file:
    path: "{{ certbot_venv_path }}"
    state: "{{ 'directory' if addon_state == 'present' else 'absent' }}"
  become: yes

- name: Install/Remove Certbot and dns-multi plugin in venv
  ansible.builtin.pip:
    name:
      - pip
      - certbot
      - certbot-dns-multi
    virtualenv: "{{ certbot_venv_path }}"
    virtualenv_command: "python3 -m venv"
    state: "{{ addon_state }}"
  become: yes

- name: Create/Remove symlink to certbot
  ansible.builtin.file:
    src: "{{ certbot_venv_path }}/bin/certbot"
    dest: /usr/bin/certbot
    state: "{{ 'link' if addon_state == 'present' else 'absent' }}"
  become: yes

- name: Create/Remove /etc/letsencrypt directory
  ansible.builtin.file:
    path: /etc/letsencrypt
    state: "{{ 'directory' if addon_state == 'present' else 'absent' }}"
    mode: "0700"
  become: yes

- name: Ensure Cloudflare token is available (from Sops)
  ansible.builtin.fail:
    msg: "Variable 'cloudflare.api_token' not found in Sops (extra_vars.sops.yml)"
  when: (cloudflare.api_token is not defined or cloudflare.api_token | length == 0) and addon_state == "present"

- name: Create dns-multi.ini credentials file
  ansible.builtin.template:
    src: dns-multi.ini.j2
    dest: "{{ certbot_credentials_path }}"
    mode: "0600"
  become: yes
  when: addon_state == "present"

- name: Remove dns-multi.ini credentials file
  ansible.builtin.file:
    path: "{{ certbot_credentials_path }}"
    state: absent
  become: yes
  when: addon_state == "absent"

- name: Request Let's Encrypt certificates (idempotent)
  ansible.builtin.command:
    cmd: >
      certbot certonly
      -a dns-multi
      --dns-multi-credentials={{ certbot_credentials_path }}
      -d "{{ item.domains | join(',') }}"
      --agree-tos
      --email {{ certbot_email }}
      --non-interactive
      --cert-name {{ item.name }}
    creates: "/etc/letsencrypt/live/{{ item.name }}/fullchain.pem"
  become: yes
  loop: "{{ certbot_domains_to_create }}"
  when: addon_state == "present"
