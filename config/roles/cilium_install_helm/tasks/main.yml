# /config/roles/cilium_install_helm/tasks/main.yml
---
- name: Установить зависимости для Helm (curl, gpg)
  ansible.builtin.apt:
    name: ["apt-transport-https", "gpg", "curl"]
    state: present
    update_cache: yes

- name: Добавить GPG-ключ Helm (Buildkite)
  ansible.builtin.shell:
    cmd: curl -fsSL https://packages.buildkite.com/helm-linux/helm-debian/gpgkey | gpg --dearmor -o /usr/share/keyrings/helm-buildkite.gpg
    creates: /usr/share/keyrings/helm-buildkite.gpg
  changed_when: false

- name: Добавить репозиторий Helm (Buildkite)
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/helm-buildkite.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main"
    state: present
    filename: helm-stable-debian

- name: Установить Helm
  ansible.builtin.apt:
    name: helm
    state: present
    update_cache: yes

# --- НАЧАЛО: БЛОК ИЗ cilium.yml ---
- name: Установить/Удалить Cilium CLI
  ansible.builtin.shell: |
    if [ ! -f "/usr/local/bin/cilium" ]; then
      CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
      CLI_ARCH=amd64
      if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
      curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
      sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
      tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
      # v--- ИСПРАВЛЕНО: Явно удаляем оба файла ---v
      rm cilium-linux-${CLI_ARCH}.tar.gz cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
    fi
  args:
    chdir: /tmp
    creates: /usr/local/bin/cilium
  changed_when: false
  when: addon_state == "present"

- name: Установить/Удалить Hubble CLI
  ansible.builtin.shell: |
    if [ ! -f "/usr/local/bin/hubble" ]; then
      HUBBLE_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
      HUBBLE_ARCH=amd64
      if [ "$(uname -m)" = "aarch64" ]; then HUBBLE_ARCH=arm64; fi
      curl -L --fail --remote-name-all https://github.com/cilium/hubble/releases/download/$HUBBLE_VERSION/hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}
      sha256sum --check hubble-linux-${HUBBLE_ARCH}.tar.gz.sha256sum
      tar xzvfC hubble-linux-${HUBBLE_ARCH}.tar.gz /usr/local/bin
      # v--- ИСПРАВЛЕНО: Явно удаляем оба файла ---v
      rm hubble-linux-${HUBBLE_ARCH}.tar.gz hubble-linux-${HUBBLE_ARCH}.tar.gz.sha256sum
    fi
  args:
    chdir: /tmp
    creates: /usr/local/bin/hubble
  changed_when: false
  when: addon_state == "present"

- name: Удалить Cilium и Hubble CLI
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/local/bin/cilium
    - /usr/local/bin/hubble
  when: addon_state == "absent"
# --- КОНЕЦ: БЛОК ИЗ cilium.yml ---

- name: Добавить репозиторий Cilium Helm
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: "{{ cilium_helm_repo_url }}"
    state: present

- name: Установить/Удалить Cilium CNI (Helm)
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: "{{ cilium_chart_version }}"
    release_namespace: "{{ cilium_namespace }}"
    create_namespace: false
    state: "{{ addon_state }}" # <-- ИСПОЛЬЗУЕМ ПЕРЕМЕННУЮ
    wait: yes
    timeout: 10m
    values:
      kubeProxyReplacement: "true"
      k8sServiceHost: "{{ ansible_fqdn }}"
      k8sServicePort: 6443
      bpf:
        masquerade: true
      securityContext:
        privileged: true
      # --- НАЧАЛО: БЛОК ИЗ cilium.yml ---
      operator:
        replicas: 1
      hubble:
        relay:
          enabled: true
        ui:
          enabled: true
        metrics:
          enabled:
            - dns
            - drop
            - tcp
            - flow
            - port-distribution
            - icmp
            - http
      prometheus:
        enabled: true
      operator.prometheus:
        enabled: true
      # --- КОНЕЦ: БЛОК ИЗ cilium.yml ---
